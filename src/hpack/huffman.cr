module HTTP2
  module HPACK
    class Huffman
      class Node
        property left : Node # bit 0
        property right : Node # bit 1
        property value : UInt8

        def leaf?
          left.nil? && right.nil?
        end

        def add(binary, len, value)
          node = self

          (len - 1).downto(0) do |i|
            if binary.bit(i) == 1
              node = (node.right ||= Node.new)
            else
              node = (node.left ||= Node.new)
            end
          end

          node.value = value
          node
        end
      end

      private getter tree : Node
      private getter minimum : Int32
      private getter maximum : Int32

      def initialize(table)
        @tree = Node.new

        table.each do |row|
          value, binary, hex, len = row
          @tree.add(binary, len, value)
        end

        sizes = table.map(&.[3])
        @minimum, @maximum = sizes.min, sizes.max
      end

      def decode(bytes : Slice(UInt8))
        io = MemoryIO.new
        node = tree

        bytes.each do |byte|
          7.downto(0) do |i|
            unless node = byte.bit(i) == 1 ? node.right : node.left
              raise Exception.new("node is nil!")
            end
            if value = node.value
              io.write_byte(value)
              node = tree
            end
          end
        end

        io.to_s
      end
    end

    def self.huffman
      @@huffman
    end

    @@huffman = Huffman.new [
      {0_u8,    0b1111111111000,                   0x1ff8,      13},
      {1_u8,    0b11111111111111111011000,         0x7fffd8,    23},
      {2_u8,    0b1111111111111111111111100010,    0xfffffe2,   28},
      {3_u8,    0b1111111111111111111111100011,    0xfffffe3,   28},
      {4_u8,    0b1111111111111111111111100100,    0xfffffe4,   28},
      {5_u8,    0b1111111111111111111111100101,    0xfffffe5,   28},
      {6_u8,    0b1111111111111111111111100110,    0xfffffe6,   28},
      {7_u8,    0b1111111111111111111111100111,    0xfffffe7,   28},
      {8_u8,    0b1111111111111111111111101000,    0xfffffe8,   28},
      {9_u8,    0b111111111111111111101010,        0xffffea,    24},
      {10_u8,   0b111111111111111111111111111100,  0x3ffffffc,  30},
      {11_u8,   0b1111111111111111111111101001,    0xfffffe9,   28},
      {12_u8,   0b1111111111111111111111101010,    0xfffffea,   28},
      {13_u8,   0b111111111111111111111111111101,  0x3ffffffd,  30},
      {14_u8,   0b1111111111111111111111101011,    0xfffffeb,   28},
      {15_u8,   0b1111111111111111111111101100,    0xfffffec,   28},
      {16_u8,   0b1111111111111111111111101101,    0xfffffed,   28},
      {17_u8,   0b1111111111111111111111101110,    0xfffffee,   28},
      {18_u8,   0b1111111111111111111111101111,    0xfffffef,   28},
      {19_u8,   0b1111111111111111111111110000,    0xffffff0,   28},
      {20_u8,   0b1111111111111111111111110001,    0xffffff1,   28},
      {21_u8,   0b1111111111111111111111110010,    0xffffff2,   28},
      {22_u8,   0b111111111111111111111111111110,  0x3ffffffe,  30},
      {23_u8,   0b1111111111111111111111110011,    0xffffff3,   28},
      {24_u8,   0b1111111111111111111111110100,    0xffffff4,   28},
      {25_u8,   0b1111111111111111111111110101,    0xffffff5,   28},
      {26_u8,   0b1111111111111111111111110110,    0xffffff6,   28},
      {27_u8,   0b1111111111111111111111110111,    0xffffff7,   28},
      {28_u8,   0b1111111111111111111111111000,    0xffffff8,   28},
      {29_u8,   0b1111111111111111111111111001,    0xffffff9,   28},
      {30_u8,   0b1111111111111111111111111010,    0xffffffa,   28},
      {31_u8,   0b1111111111111111111111111011,    0xffffffb,   28},
      {32_u8,   0b010100,                          0x14,        6},
      {33_u8,   0b1111111000,                      0x3f8,       10},
      {34_u8,   0b1111111001,                      0x3f9,       10},
      {35_u8,   0b111111111010,                    0xffa,       12},
      {36_u8,   0b1111111111001,                   0x1ff9,      13},
      {37_u8,   0b010101,                          0x15,        6},
      {38_u8,   0b11111000,                        0xf8,        8},
      {39_u8,   0b11111111010,                     0x7fa,       11},
      {40_u8,   0b1111111010,                      0x3fa,       10},
      {41_u8,   0b1111111011,                      0x3fb,       10},
      {42_u8,   0b11111001,                        0xf9,        8},
      {43_u8,   0b11111111011,                     0x7fb,       11},
      {44_u8,   0b11111010,                        0xfa,        8},
      {45_u8,   0b010110,                          0x16,        6},
      {46_u8,   0b010111,                          0x17,        6},
      {47_u8,   0b011000,                          0x18,        6},
      {48_u8,   0b00000,                           0x0,         5},
      {49_u8,   0b00001,                           0x1,         5},
      {50_u8,   0b00010,                           0x2,         5},
      {51_u8,   0b011001,                          0x19,        6},
      {52_u8,   0b011010,                          0x1a,        6},
      {53_u8,   0b011011,                          0x1b,        6},
      {54_u8,   0b011100,                          0x1c,        6},
      {55_u8,   0b011101,                          0x1d,        6},
      {56_u8,   0b011110,                          0x1e,        6},
      {57_u8,   0b011111,                          0x1f,        6},
      {58_u8,   0b1011100,                         0x5c,        7},
      {59_u8,   0b11111011,                        0xfb,        8},
      {60_u8,   0b111111111111100,                 0x7ffc,      15},
      {61_u8,   0b100000,                          0x20,        6},
      {62_u8,   0b111111111011,                    0xffb,       12},
      {63_u8,   0b1111111100,                      0x3fc,       10},
      {64_u8,   0b1111111111010,                   0x1ffa,      13},
      {65_u8,   0b100001,                          0x21,        6},
      {66_u8,   0b1011101,                         0x5d,        7},
      {67_u8,   0b1011110,                         0x5e,        7},
      {68_u8,   0b1011111,                         0x5f,        7},
      {69_u8,   0b1100000,                         0x60,        7},
      {70_u8,   0b1100001,                         0x61,        7},
      {71_u8,   0b1100010,                         0x62,        7},
      {72_u8,   0b1100011,                         0x63,        7},
      {73_u8,   0b1100100,                         0x64,        7},
      {74_u8,   0b1100101,                         0x65,        7},
      {75_u8,   0b1100110,                         0x66,        7},
      {76_u8,   0b1100111,                         0x67,        7},
      {77_u8,   0b1101000,                         0x68,        7},
      {78_u8,   0b1101001,                         0x69,        7},
      {79_u8,   0b1101010,                         0x6a,        7},
      {80_u8,   0b1101011,                         0x6b,        7},
      {81_u8,   0b1101100,                         0x6c,        7},
      {82_u8,   0b1101101,                         0x6d,        7},
      {83_u8,   0b1101110,                         0x6e,        7},
      {84_u8,   0b1101111,                         0x6f,        7},
      {85_u8,   0b1110000,                         0x70,        7},
      {86_u8,   0b1110001,                         0x71,        7},
      {87_u8,   0b1110010,                         0x72,        7},
      {88_u8,   0b11111100,                        0xfc,        8},
      {89_u8,   0b1110011,                         0x73,        7},
      {90_u8,   0b11111101,                        0xfd,        8},
      {91_u8,   0b1111111111011,                   0x1ffb,      13},
      {92_u8,   0b1111111111111110000,             0x7fff0,     19},
      {93_u8,   0b1111111111100,                   0x1ffc,      13},
      {94_u8,   0b11111111111100,                  0x3ffc,      14},
      {95_u8,   0b100010,                          0x22,        6},
      {96_u8,   0b111111111111101,                 0x7ffd,      15},
      {97_u8,   0b00011,                           0x3,         5},
      {98_u8,   0b100011,                          0x23,        6},
      {99_u8,   0b00100,                           0x4,         5},
      {100_u8,  0b100100,                          0x24,        6},
      {101_u8,  0b00101,                           0x5,         5},
      {102_u8,  0b100101,                          0x25,        6},
      {103_u8,  0b100110,                          0x26,        6},
      {104_u8,  0b100111,                          0x27,        6},
      {105_u8,  0b00110,                           0x6,         5},
      {106_u8,  0b1110100,                         0x74,        7},
      {107_u8,  0b1110101,                         0x75,        7},
      {108_u8,  0b101000,                          0x28,        6},
      {109_u8,  0b101001,                          0x29,        6},
      {110_u8,  0b101010,                          0x2a,        6},
      {111_u8,  0b00111,                           0x7,         5},
      {112_u8,  0b101011,                          0x2b,        6},
      {113_u8,  0b1110110,                         0x76,        7},
      {114_u8,  0b101100,                          0x2c,        6},
      {115_u8,  0b01000,                           0x8,         5},
      {116_u8,  0b01001,                           0x9,         5},
      {117_u8,  0b101101,                          0x2d,        6},
      {118_u8,  0b1110111,                         0x77,        7},
      {119_u8,  0b1111000,                         0x78,        7},
      {120_u8,  0b1111001,                         0x79,        7},
      {121_u8,  0b1111010,                         0x7a,        7},
      {122_u8,  0b1111011,                         0x7b,        7},
      {123_u8,  0b111111111111110,                 0x7ffe,      15},
      {124_u8,  0b11111111100,                     0x7fc,       11},
      {125_u8,  0b11111111111101,                  0x3ffd,      14},
      {126_u8,  0b1111111111101,                   0x1ffd,      13},
      {127_u8,  0b1111111111111111111111111100,    0xffffffc,   28},
      {128_u8,  0b11111111111111100110,            0xfffe6,     20},
      {129_u8,  0b1111111111111111010010,          0x3fffd2,    22},
      {130_u8,  0b11111111111111100111,            0xfffe7,     20},
      {131_u8,  0b11111111111111101000,            0xfffe8,     20},
      {132_u8,  0b1111111111111111010011,          0x3fffd3,    22},
      {133_u8,  0b1111111111111111010100,          0x3fffd4,    22},
      {134_u8,  0b1111111111111111010101,          0x3fffd5,    22},
      {135_u8,  0b11111111111111111011001,         0x7fffd9,    23},
      {136_u8,  0b1111111111111111010110,          0x3fffd6,    22},
      {137_u8,  0b11111111111111111011010,         0x7fffda,    23},
      {138_u8,  0b11111111111111111011011,         0x7fffdb,    23},
      {139_u8,  0b11111111111111111011100,         0x7fffdc,    23},
      {140_u8,  0b11111111111111111011101,         0x7fffdd,    23},
      {141_u8,  0b11111111111111111011110,         0x7fffde,    23},
      {142_u8,  0b111111111111111111101011,        0xffffeb,    24},
      {143_u8,  0b11111111111111111011111,         0x7fffdf,    23},
      {144_u8,  0b111111111111111111101100,        0xffffec,    24},
      {145_u8,  0b111111111111111111101101,        0xffffed,    24},
      {146_u8,  0b1111111111111111010111,          0x3fffd7,    22},
      {147_u8,  0b11111111111111111100000,         0x7fffe0,    23},
      {148_u8,  0b111111111111111111101110,        0xffffee,    24},
      {149_u8,  0b11111111111111111100001,         0x7fffe1,    23},
      {150_u8,  0b11111111111111111100010,         0x7fffe2,    23},
      {151_u8,  0b11111111111111111100011,         0x7fffe3,    23},
      {152_u8,  0b11111111111111111100100,         0x7fffe4,    23},
      {153_u8,  0b111111111111111011100,           0x1fffdc,    21},
      {154_u8,  0b1111111111111111011000,          0x3fffd8,    22},
      {155_u8,  0b11111111111111111100101,         0x7fffe5,    23},
      {156_u8,  0b1111111111111111011001,          0x3fffd9,    22},
      {157_u8,  0b11111111111111111100110,         0x7fffe6,    23},
      {158_u8,  0b11111111111111111100111,         0x7fffe7,    23},
      {159_u8,  0b111111111111111111101111,        0xffffef,    24},
      {160_u8,  0b1111111111111111011010,          0x3fffda,    22},
      {161_u8,  0b111111111111111011101,           0x1fffdd,    21},
      {162_u8,  0b11111111111111101001,            0xfffe9,     20},
      {163_u8,  0b1111111111111111011011,          0x3fffdb,    22},
      {164_u8,  0b1111111111111111011100,          0x3fffdc,    22},
      {165_u8,  0b11111111111111111101000,         0x7fffe8,    23},
      {166_u8,  0b11111111111111111101001,         0x7fffe9,    23},
      {167_u8,  0b111111111111111011110,           0x1fffde,    21},
      {168_u8,  0b11111111111111111101010,         0x7fffea,    23},
      {169_u8,  0b1111111111111111011101,          0x3fffdd,    22},
      {170_u8,  0b1111111111111111011110,          0x3fffde,    22},
      {171_u8,  0b111111111111111111110000,        0xfffff0,    24},
      {172_u8,  0b111111111111111011111,           0x1fffdf,    21},
      {173_u8,  0b1111111111111111011111,          0x3fffdf,    22},
      {174_u8,  0b11111111111111111101011,         0x7fffeb,    23},
      {175_u8,  0b11111111111111111101100,         0x7fffec,    23},
      {176_u8,  0b111111111111111100000,           0x1fffe0,    21},
      {177_u8,  0b111111111111111100001,           0x1fffe1,    21},
      {178_u8,  0b1111111111111111100000,          0x3fffe0,    22},
      {179_u8,  0b111111111111111100010,           0x1fffe2,    21},
      {180_u8,  0b11111111111111111101101,         0x7fffed,    23},
      {181_u8,  0b1111111111111111100001,          0x3fffe1,    22},
      {182_u8,  0b11111111111111111101110,         0x7fffee,    23},
      {183_u8,  0b11111111111111111101111,         0x7fffef,    23},
      {184_u8,  0b11111111111111101010,            0xfffea,     20},
      {185_u8,  0b1111111111111111100010,          0x3fffe2,    22},
      {186_u8,  0b1111111111111111100011,          0x3fffe3,    22},
      {187_u8,  0b1111111111111111100100,          0x3fffe4,    22},
      {188_u8,  0b11111111111111111110000,         0x7ffff0,    23},
      {189_u8,  0b1111111111111111100101,          0x3fffe5,    22},
      {190_u8,  0b1111111111111111100110,          0x3fffe6,    22},
      {191_u8,  0b11111111111111111110001,         0x7ffff1,    23},
      {192_u8,  0b11111111111111111111100000,      0x3ffffe0,   26},
      {193_u8,  0b11111111111111111111100001,      0x3ffffe1,   26},
      {194_u8,  0b11111111111111101011,            0xfffeb,     20},
      {195_u8,  0b1111111111111110001,             0x7fff1,     19},
      {196_u8,  0b1111111111111111100111,          0x3fffe7,    22},
      {197_u8,  0b11111111111111111110010,         0x7ffff2,    23},
      {198_u8,  0b1111111111111111101000,          0x3fffe8,    22},
      {199_u8,  0b1111111111111111111101100,       0x1ffffec,   25},
      {200_u8,  0b11111111111111111111100010,      0x3ffffe2,   26},
      {201_u8,  0b11111111111111111111100011,      0x3ffffe3,   26},
      {202_u8,  0b11111111111111111111100100,      0x3ffffe4,   26},
      {203_u8,  0b111111111111111111111011110,     0x7ffffde,   27},
      {204_u8,  0b111111111111111111111011111,     0x7ffffdf,   27},
      {205_u8,  0b11111111111111111111100101,      0x3ffffe5,   26},
      {206_u8,  0b111111111111111111110001,        0xfffff1,    24},
      {207_u8,  0b1111111111111111111101101,       0x1ffffed,   25},
      {208_u8,  0b1111111111111110010,             0x7fff2,     19},
      {209_u8,  0b111111111111111100011,           0x1fffe3,    21},
      {210_u8,  0b11111111111111111111100110,      0x3ffffe6,   26},
      {211_u8,  0b111111111111111111111100000,     0x7ffffe0,   27},
      {212_u8,  0b111111111111111111111100001,     0x7ffffe1,   27},
      {213_u8,  0b11111111111111111111100111,      0x3ffffe7,   26},
      {214_u8,  0b111111111111111111111100010,     0x7ffffe2,   27},
      {215_u8,  0b111111111111111111110010,        0xfffff2,    24},
      {216_u8,  0b111111111111111100100,           0x1fffe4,    21},
      {217_u8,  0b111111111111111100101,           0x1fffe5,    21},
      {218_u8,  0b11111111111111111111101000,      0x3ffffe8,   26},
      {219_u8,  0b11111111111111111111101001,      0x3ffffe9,   26},
      {220_u8,  0b1111111111111111111111111101,    0xffffffd,   28},
      {221_u8,  0b111111111111111111111100011,     0x7ffffe3,   27},
      {222_u8,  0b111111111111111111111100100,     0x7ffffe4,   27},
      {223_u8,  0b111111111111111111111100101,     0x7ffffe5,   27},
      {224_u8,  0b11111111111111101100,            0xfffec,     20},
      {225_u8,  0b111111111111111111110011,        0xfffff3,    24},
      {226_u8,  0b11111111111111101101,            0xfffed,     20},
      {227_u8,  0b111111111111111100110,           0x1fffe6,    21},
      {228_u8,  0b1111111111111111101001,          0x3fffe9,    22},
      {229_u8,  0b111111111111111100111,           0x1fffe7,    21},
      {230_u8,  0b111111111111111101000,           0x1fffe8,    21},
      {231_u8,  0b11111111111111111110011,         0x7ffff3,    23},
      {232_u8,  0b1111111111111111101010,          0x3fffea,    22},
      {233_u8,  0b1111111111111111101011,          0x3fffeb,    22},
      {234_u8,  0b1111111111111111111101110,       0x1ffffee,   25},
      {235_u8,  0b1111111111111111111101111,       0x1ffffef,   25},
      {236_u8,  0b111111111111111111110100,        0xfffff4,    24},
      {237_u8,  0b111111111111111111110101,        0xfffff5,    24},
      {238_u8,  0b11111111111111111111101010,      0x3ffffea,   26},
      {239_u8,  0b11111111111111111110100,         0x7ffff4,    23},
      {240_u8,  0b11111111111111111111101011,      0x3ffffeb,   26},
      {241_u8,  0b111111111111111111111100110,     0x7ffffe6,   27},
      {242_u8,  0b11111111111111111111101100,      0x3ffffec,   26},
      {243_u8,  0b11111111111111111111101101,      0x3ffffed,   26},
      {244_u8,  0b111111111111111111111100111,     0x7ffffe7,   27},
      {245_u8,  0b111111111111111111111101000,     0x7ffffe8,   27},
      {246_u8,  0b111111111111111111111101001,     0x7ffffe9,   27},
      {247_u8,  0b111111111111111111111101010,     0x7ffffea,   27},
      {248_u8,  0b111111111111111111111101011,     0x7ffffeb,   27},
      {249_u8,  0b1111111111111111111111111110,    0xffffffe,   28},
      {250_u8,  0b111111111111111111111101100,     0x7ffffec,   27},
      {251_u8,  0b111111111111111111111101101,     0x7ffffed,   27},
      {252_u8,  0b111111111111111111111101110,     0x7ffffee,   27},
      {253_u8,  0b111111111111111111111101111,     0x7ffffef,   27},
      {254_u8,  0b111111111111111111111110000,     0x7fffff0,   27},
      {255_u8,  0b11111111111111111111101110,      0x3ffffee,   26},
     #{256_u8,  0b111111111111111111111111111111,  0x3fffffff,  30},
    ]
  end
end
